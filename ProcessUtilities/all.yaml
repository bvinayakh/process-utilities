NAME: airflowdemo202
LAST DEPLOYED: Thu Apr 22 16:03:04 2021
NAMESPACE: cloudez-demo
STATUS: pending-install
REVISION: 1
TEST SUITE: None
USER-SUPPLIED VALUES:
config:
  logging:
    remote_base_log_folder: cloudwatch://arn:aws:logs:us-west-2:140199734014:log-group:airflow-logs
dags:
  gitSync:
    branch: master
    enabled: true
    repo: git@bitbucket.org:8kmilesinternal/dez-airflow-dags
    sshKeySecret: airflowdemo202-git-creds
defaultAirflowRepository: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images
defaultAirflowTag: apache-airflow-v2.0.1
ingress:
  enabled: true
  web:
    host: airflowdemo202-sbx.dataez.hti.com
scheduler:
  serviceAccountAnnotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::270579433622:role/ROLE-DEZ-USW2-DATAPLATFORM-01-SBX-AIRFLOWDEMO202-POD
webserver:
  defaultUser:
    email: admin@caspiandemo.com
    enabled: true
    firstName: admin
    lastName: user
    password: admin@casp
    role: Admin
    username: admin
  ldap:
    ADMIN_USER_GROUP: dez-airflow-admin-group
    AUTH_LDAP_BIND_PASSWORD: 2SbKVMQ4Prj6
    AUTH_LDAP_BIND_USER: svc-airflow@dataez.hti.com
  serviceAccountAnnotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::270579433622:role/ROLE-DEZ-USW2-DATAPLATFORM-01-SBX-AIRFLOWDEMO202-POD
workers:
  serviceAccountAnnotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::270579433622:role/ROLE-DEZ-USW2-DATAPLATFORM-01-SBX-AIRFLOWDEMO202-POD

COMPUTED VALUES:
affinity: {}
airflowHome: /opt/airflow
airflowPodAnnotations: {}
allowPodLaunching: true
cleanup:
  affinity: {}
  enabled: false
  nodeSelector: {}
  schedule: '*/15 * * * *'
  tolerations: []
config:
  api:
    auth_backend: airflow.api.auth.backend.deny_all
  celery:
    default_queue: celery
    worker_concurrency: 16
  core:
    colored_console_log: "True"
    dags_folder: '{{ include "airflow_dags" . }}'
    executor: '{{ .Values.executor }}'
    load_examples: "False"
  elasticsearch:
    json_format: "True"
    log_id_template: '{dag_id}_{task_id}_{execution_date}_{try_number}'
  elasticsearch_configs:
    max_retries: 3
    retry_timeout: "True"
    timeout: 30
  kerberos:
    ccache: '{{ .Values.kerberos.ccacheMountPath }}/{{ .Values.kerberos.ccacheFileName }}'
    keytab: '{{ .Values.kerberos.keytabPath }}'
    principal: '{{ .Values.kerberos.principal }}'
    reinit_frequency: '{{ .Values.kerberos.reinitFrequency }}'
  kubernetes:
    airflow_configmap: '{{ include "airflow_config" . }}'
    airflow_local_settings_configmap: '{{ include "airflow_config" . }}'
    delete_worker_pods: "True"
    multi_namespace_mode: '{{ if .Values.multiNamespaceMode }}True{{ else }}False{{ end }}'
    namespace: '{{ .Release.Namespace }}'
    pod_template_file: '{{ include "airflow_pod_template_file" . }}/pod_template_file.yaml'
    worker_container_repository: '{{ .Values.images.airflow.repository | default .Values.defaultAirflowRepository }}'
    worker_container_tag: '{{ .Values.images.airflow.tag | default .Values.defaultAirflowTag }}'
  logging:
    colored_console_log: "True"
    fab_logging_level: DEBUG
    logging_level: INFO
    remote_base_log_folder: cloudwatch://arn:aws:logs:us-west-2:140199734014:log-group:airflow-logs
    remote_logging: true
  metrics:
    statsd_host: '{{ printf "%s-statsd" .Release.Name }}'
    statsd_on: '{{ ternary "True" "False" .Values.statsd.enabled }}'
    statsd_port: 9125
    statsd_prefix: airflow
  scheduler:
    run_duration: 41460
    scheduler_heartbeat_sec: 5
    statsd_host: '{{ printf "%s-statsd" .Release.Name }}'
    statsd_on: '{{ ternary "True" "False" .Values.statsd.enabled }}'
    statsd_port: 9125
    statsd_prefix: airflow
  webserver:
    enable_proxy_fix: "True"
    rbac: "True"
dags:
  gitSync:
    branch: master
    containerName: git-sync
    depth: 1
    dest: repo
    enabled: true
    knownHosts: |
      bitbucket.org ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAubiN81eDcafrgMeLzaFPsw2kNvEcqTKl/VqLat/MaB33pZy0y3rJZtnqwR2qOOvbwKZYKiEO1O6VqNEBxKvJJelCq0dTXWT5pbO2gDXC6h6QDXCaHo6pOHGPUy+YBaGQRGuSusMEASYiWunYN0vCAI8QaXnWMXNMdFP3jHAJH0eDsoiGnLPBlBp4TNm6rYI74nMzgz3B9IikW4WVK+dc8KZJZWYjAuORU3jc1c/NPskD2ASinf8v3xnfXeukU0sJ5N6m5E8VLjObPEO+mN2t/FZTMZLiFqPWc/ALSqnMnnhwrNi2rbfg/rd/IpL8Le3pSBne8+seeFVBoGqzHM9yXw==
    maxFailures: 0
    repo: git@bitbucket.org:8kmilesinternal/dez-airflow-dags
    rev: HEAD
    root: /git
    sshKeySecret: airflowdemo202-git-creds
    subPath: ""
    uid: 65533
    wait: 60
  persistence:
    accessMode: ReadWriteOnce
    enabled: false
    existingClaim: null
    size: 1Gi
    storageClassName: null
data:
  brokerUrl: null
  brokerUrlSecretName: null
  metadataConnection:
    db: postgres
    host: null
    pass: postgres
    port: 5432
    sslmode: disable
    user: postgres
  metadataSecretName: null
  resultBackendConnection:
    db: postgres
    host: null
    pass: postgres
    port: 5432
    sslmode: disable
    user: postgres
  resultBackendSecretName: null
defaultAirflowRepository: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images
defaultAirflowTag: apache-airflow-v2.0.1
elasticsearch:
  connection: {}
  enabled: false
  secretName: null
env: []
executor: KubernetesExecutor
extraConfigMaps: {}
extraEnv: null
extraEnvFrom: null
extraSecrets: {}
fernetKey: null
fernetKeySecretName: null
flower:
  affinity: {}
  enabled: true
  extraNetworkPolicies: []
  nodeSelector: {}
  password: null
  resources: {}
  secretName: null
  service:
    type: ClusterIP
  tolerations: []
  username: null
gid: 50000
git_ssh: |-
  -----BEGIN OPENSSH PRIVATE KEY-----
  b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
  NhAAAAAwEAAQAAAYEAwEh5b5+ujnlxQvexnFY/p/rdn3bID6gTOwH5+/2FKBC+tU9nOUMv
  AkO1xZlc1S8kKHKA2nQs4Koy5zzxJQsHHW1HeDCCJhSFGAKsqBHZptxbVTwkc5MCMVgu3f
  BnnkBkk+VjpFKVB9C2jkX7lSmOfgZWshDJ0UX5lS7tTzEPNzb8C20dm3pJtwnXIXIlR4zz
  ORqKjNtI6WxcKHkMS3Pl1/20AkuwbxflwR7IUA4nbihYQTE2BMp0qzociWf/pK7FRaEMX1
  grW8Uzr9hCxBanxwW0NC+uUPjDox+fEtlJYLF2wVwQ+jRu+G8JHD0S5D0ZOGg7Vl848hwA
  j0DYu2wX6gb5+x4AQcj4OI1M1JPik7JXesu60yRnLHKm4dB5QEHeCSAQBy6T9EnVCDMnbz
  aM/jT3UaXKmmttSlrYu5ALYTQx9EsCvlPFMuXzubTlqKNNOWZhDI2Ox2tGq9JkXCLpfkRI
  wUomyGCAtcjPohX3v4i9LhggL5PrZQpiAejHGQAVAAAFmJxeObCcXjmwAAAAB3NzaC1yc2
  EAAAGBAMBIeW+fro55cUL3sZxWP6f63Z92yA+oEzsB+fv9hSgQvrVPZzlDLwJDtcWZXNUv
  JChygNp0LOCqMuc88SULBx1tR3gwgiYUhRgCrKgR2abcW1U8JHOTAjFYLt3wZ55AZJPlY6
  RSlQfQto5F+5Upjn4GVrIQydFF+ZUu7U8xDzc2/AttHZt6SbcJ1yFyJUeM8zkaiozbSOls
  XCh5DEtz5df9tAJLsG8X5cEeyFAOJ24oWEExNgTKdKs6HIln/6SuxUWhDF9YK1vFM6/YQs
  QWp8cFtDQvrlD4w6MfnxLZSWCxdsFcEPo0bvhvCRw9EuQ9GThoO1ZfOPIcAI9A2LtsF+oG
  +fseAEHI+DiNTNST4pOyV3rLutMkZyxypuHQeUBB3gkgEAcuk/RJ1QgzJ282jP4091Glyp
  prbUpa2LuQC2E0MfRLAr5TxTLl87m05aijTTlmYQyNjsdrRqvSZFwi6X5ESMFKJshggLXI
  z6IV97+IvS4YIC+T62UKYgHoxxkAFQAAAAMBAAEAAAGAU33kxPRYTmMrLAHzrEfDIkSLAR
  gJrMq1dvTXwHSH4irLNF1DHBkxC1GtVxzNs3/hunJlwvWZGwCsU74hk40jTMLLusONb82P
  MSrQH7aIhKzAN9WCmnCmDhkVWKdvxsZ9Jb8AMjTto1QcQNDgehduWQiVkoI5r9Yrlnym7L
  EHw1jrvmZl6cICyijKsionR9dLMWt158277idwKN7O2OB9V/lAtZJ6DPMaf23HWwOaWXnJ
  QJ2GsDPczxDPnVZ8Kdz86C62rLbC6pv6i7ZME8HC5CgOKDVu7G2rSK9ci5tev9xG5p21jY
  KjYyab3QTwXMUOE8TE38vB4lhplDcq0CsQlaypefnU+T187EeCksAeULYM4a2qDi58uUOr
  zHEc3xQRvAabaJ8RnL/U9C0pjpEOArxfxnx2XhRxnQAUdce2Xk8ePGJ+GzOLb+B547TMSt
  8N+wVFiG9+HtKdTb8V8EApVw65dA1N4xWbNuM1dXtBD+ebrtNldeFHlRp3BzYJ3yONAAAA
  wQCA29vUjksGNlGTz9tW8vRuSVOoLm9wL5cYS7zncLBizWsYl8GSB6GgNGhzYCYgNw+O9l
  yVKGtVyWph8Hdte9zbXRq7kFiTP5kh3bSleresLQS9eYZNytMSd8AtQ+OQf/0HrZTd3C7L
  ar7rNfrbGWL0LdJqhDGSK6/PknboKWE7hJkDnKpTjbgiY6dkDWx+hom/LNp5jRHLyW3Q84
  LbxZn1UDNInJ+yrKVdhCS+0fhpT2KdtzkP6PMnVeVVCgOgtDUAAADBAPTcoV74eJOy4eBd
  7F+bWzvWeaA1K+nd5nAr7CbDj1Uagas5WtY6c5wFcJMs7hFpGOoG18Lt9D5Gw+VKHBFEZR
  YQChYzLPMzsdtUyniS1yeJH0dFAG6e81uC4FMPlBnVstqzIWBpj1gknLgHfJ/i6qmPxdxU
  mkZaLJmu52lsta8rgDf80XhJbMaC6QNxzzV0d2MDGr0agG+xbIGwiAfmriOBHZxVLm28+n
  TrL6mvtZYf9ktdQQaVR+uaThW5aBJZywAAAMEAyQeTGhbsfyjhVfzoYSwsT8jAkk8ZDS8t
  /4ipfqGFlly4HxArTYcFxXM9TQ+zGS6sbcTaLvpl0ODjM6Z7ru7dJcycAm40MYx7+TwnaD
  3P7J77MVE9d1hY4BLJn8+OSq1UHxWPE1jtucY5fdeljwIyZRrERlQopl+uznghYP93W7+o
  3Gfc24xuZZrK1qjZzTrmervmB0rETXInGGpjtQ8DMwkLixdMrekbJGhQRK3qed0eBG2qTA
  cOAHxbMSp+nlGfAAAAImthbHlhbmlAS2FseWFuaXMtTWFjQm9vay1BaXIubG9jYWw=
  -----END OPENSSH PRIVATE KEY-----
images:
  airflow:
    pullPolicy: IfNotPresent
    repository: null
    tag: null
  flower:
    pullPolicy: IfNotPresent
    repository: null
    tag: null
  gitSync:
    pullPolicy: IfNotPresent
    repository: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images
    tag: gcr-git-sync-v3.1.6
  pgbouncer:
    pullPolicy: IfNotPresent
    repository: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images
    tag: airflow-pgbouncer-2020.09.05-1.14.0
  pgbouncerExporter:
    pullPolicy: IfNotPresent
    repository: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images
    tag: airflow-pgbouncer-exporter-2020.09.25-0.5.0
  pod_template:
    pullPolicy: IfNotPresent
    repository: null
    tag: null
  redis:
    pullPolicy: IfNotPresent
    repository: redis
    tag: 6-buster
  statsd:
    pullPolicy: IfNotPresent
    repository: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images
    tag: airflow-statsd-exporter-2020.09.05-v0.17.0
ingress:
  enabled: true
  flower:
    annotations: {}
    host: ""
    path: ""
    precedingPaths: []
    succeedingPaths: []
    tls:
      enabled: false
      secretName: ""
  web:
    annotations:
      kubernetes.io/ingress.class: nginx
      nginx.ingress.kubernetes.io/rewrite-target: /
    host: airflowdemo202-sbx.dataez.hti.com
    path: ""
    precedingPaths: []
    succeedingPaths: []
    tls:
      enabled: false
      secretName: ""
kerberos:
  ccacheFileName: cache
  ccacheMountPath: /var/kerberos-ccache
  config: |
    # This is an example config showing how you can use templating and how "example" config
    # might look like. It works with the test kerberos server that we are using during integration
    # testing at Apache Airflow (see `scripts/ci/docker-compose/integration-kerberos.yml` but in
    # order to make it production-ready you must replace it with your own configuration that
    # Matches your kerberos deployment. Administrators of your Kerberos instance should
    # provide the right configuration.

    [logging]
    default = "FILE:{{ template "airflow_logs_no_quote" . }}/kerberos_libs.log"
    kdc = "FILE:{{ template "airflow_logs_no_quote" . }}/kerberos_kdc.log"
    admin_server = "FILE:{{ template "airflow_logs_no_quote" . }}/kadmind.log"

    [libdefaults]
    default_realm = FOO.COM
    ticket_lifetime = 10h
    renew_lifetime = 7d
    forwardable = true

    [realms]
    FOO.COM = {
      kdc = kdc-server.foo.com
      admin_server = admin_server.foo.com
    }
  configPath: /etc/krb5.conf
  enabled: false
  keytabPath: /etc/airflow.keytab
  principal: airflow@FOO.COM
  reinitFrequency: 3600
labels: {}
limits: []
multiNamespaceMode: false
networkPolicies:
  enabled: false
nodeSelector:
  az: zone1
pgbouncer:
  affinity: {}
  ciphers: normal
  enabled: false
  extraNetworkPolicies: []
  logConnections: 0
  logDisconnections: 0
  maxClientConn: 100
  metadataPoolSize: 10
  nodeSelector: {}
  podDisruptionBudget:
    config:
      maxUnavailable: 1
    enabled: false
  resources: {}
  resultBackendPoolSize: 5
  service:
    extraAnnotations: {}
  ssl:
    ca: null
    cert: null
    key: null
  sslmode: prefer
  tolerations: []
  verbose: 0
podTemplate: null
ports:
  airflowUI: 8080
  flowerUI: 5555
  pgbouncer: 6543
  pgbouncerScrape: 9127
  redisDB: 6379
  statsdIngest: 9125
  statsdScrape: 9102
  workerLogs: 8793
postgresql:
  enabled: true
  extraEnv: {}
  global:
    postgresql: {}
  image:
    debug: false
    pullPolicy: IfNotPresent
    registry: 140199734014.dkr.ecr.us-west-2.amazonaws.com
    repository: common-images
    tag: bitnami-postgresql-11.5.0-debian-9-r60
  livenessProbe:
    enabled: true
    failureThreshold: 6
    initialDelaySeconds: 30
    periodSeconds: 10
    successThreshold: 1
    timeoutSeconds: 5
  master:
    affinity: {}
    extraVolumeMounts: []
    extraVolumes: []
    nodeSelector: {}
    podAnnotations: {}
    podLabels: {}
    tolerations: []
  metrics:
    enabled: false
    image:
      pullPolicy: IfNotPresent
      registry: docker.io
      repository: bitnami/postgres-exporter
      tag: 0.5.1-debian-9-r73
    livenessProbe:
      enabled: true
      failureThreshold: 6
      initialDelaySeconds: 5
      periodSeconds: 10
      successThreshold: 1
      timeoutSeconds: 5
    readinessProbe:
      enabled: true
      failureThreshold: 6
      initialDelaySeconds: 5
      periodSeconds: 10
      successThreshold: 1
      timeoutSeconds: 5
    securityContext:
      enabled: false
      runAsUser: 1001
    service:
      annotations:
        prometheus.io/port: "9187"
        prometheus.io/scrape: "true"
      type: ClusterIP
    serviceMonitor:
      additionalLabels: {}
      enabled: false
  networkPolicy:
    allowExternal: true
    enabled: false
  persistence:
    accessModes:
    - ReadWriteOnce
    annotations: {}
    enabled: true
    mountPath: /bitnami/postgresql
    size: 8Gi
    subPath: ""
  postgresqlDataDir: /bitnami/postgresql/data
  postgresqlPassword: postgres
  postgresqlUsername: postgres
  readinessProbe:
    enabled: true
    failureThreshold: 6
    initialDelaySeconds: 5
    periodSeconds: 10
    successThreshold: 1
    timeoutSeconds: 5
  replication:
    applicationName: my_application
    enabled: false
    numSynchronousReplicas: 0
    password: repl_password
    slaveReplicas: 1
    synchronousCommit: "off"
    user: repl_user
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
  securityContext:
    enabled: true
    fsGroup: 1001
    runAsUser: 1001
  service:
    annotations: {}
    port: 5432
    type: ClusterIP
  serviceAccount:
    enabled: false
  slave:
    affinity: {}
    extraVolumeMounts: []
    extraVolumes: []
    nodeSelector: {}
    podAnnotations: {}
    podLabels: {}
    tolerations: []
  updateStrategy:
    type: RollingUpdate
  volumePermissions:
    enabled: true
    image:
      pullPolicy: Always
      registry: 140199734014.dkr.ecr.us-west-2.amazonaws.com
      repository: common-images
      tag: bitnami-minideb-stretch
    securityContext:
      runAsUser: 0
quotas: {}
rbacEnabled: true
redis:
  affinity: {}
  enabled: true
  nodeSelector: {}
  password: null
  passwordSecretName: null
  persistence:
    enabled: true
    size: 1Gi
    storageClassName: null
  resources: {}
  safeToEvict: true
  terminationGracePeriodSeconds: 600
  tolerations: []
registry:
  connection: {}
  secretName: null
scheduler:
  affinity: {}
  airflowLocalSettings: null
  extraVolumeMounts: []
  extraVolumes: []
  nodeSelector: {}
  podDisruptionBudget:
    config:
      maxUnavailable: 1
    enabled: false
  replicas: 1
  resources: {}
  safeToEvict: true
  serviceAccountAnnotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::270579433622:role/ROLE-DEZ-USW2-DATAPLATFORM-01-SBX-AIRFLOWDEMO202-POD
  tolerations: []
secret: []
statsd:
  affinity: {}
  enabled: true
  extraMappings: []
  extraNetworkPolicies: []
  nodeSelector:
    az: zone1
  resources: {}
  service:
    extraAnnotations: {}
  tolerations: []
tolerations: []
uid: 50000
webserver:
  affinity: {}
  allowPodLogReading: true
  defaultUser:
    email: admin@caspiandemo.com
    enabled: true
    firstName: admin
    lastName: user
    password: admin@casp
    role: Admin
    username: admin
  extraNetworkPolicies: []
  extraVolumeMounts: []
  extraVolumes: []
  ldap:
    ADMIN_USER_GROUP: dez-airflow-admin-group
    AUTH_LDAP_BIND_PASSWORD: 2SbKVMQ4Prj6
    AUTH_LDAP_BIND_USER: svc-airflow@dataez.hti.com
  livenessProbe:
    failureThreshold: 20
    initialDelaySeconds: 15
    periodSeconds: 5
    timeoutSeconds: 30
  nodeSelector: {}
  readinessProbe:
    failureThreshold: 20
    initialDelaySeconds: 15
    periodSeconds: 5
    timeoutSeconds: 30
  replicas: 1
  resources: {}
  service:
    annotations: {}
    type: ClusterIP
  serviceAccountAnnotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::270579433622:role/ROLE-DEZ-USW2-DATAPLATFORM-01-SBX-AIRFLOWDEMO202-POD
  tolerations: []
  webserverConfig: null
workers:
  affinity: {}
  extraVolumeMounts: []
  extraVolumes: []
  keda:
    cooldownPeriod: 30
    enabled: false
    maxReplicaCount: 10
    namespaceLabels: {}
    pollingInterval: 5
  kerberosSidecar:
    enabled: false
    resources: {}
  nodeSelector: {}
  persistence:
    enabled: true
    fixPermissions: false
    size: 100Gi
    storageClassName: null
  replicas: 1
  resources: {}
  safeToEvict: true
  serviceAccountAnnotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::270579433622:role/ROLE-DEZ-USW2-DATAPLATFORM-01-SBX-AIRFLOWDEMO202-POD
  terminationGracePeriodSeconds: 600
  tolerations: []

HOOKS:
---
# Source: airflow/templates/secrets/fernetkey-secret.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Fernet Key Secret
#################################

kind: Secret
apiVersion: v1
metadata:
  name: airflowdemo202-fernet-key
  labels:
    release: airflowdemo202
    chart: airflow
    heritage: Helm
  annotations:
    "helm.sh/hook": "pre-install"
    "helm.sh/hook-delete-policy": "before-hook-creation"
    "helm.sh/hook-weight": "0"
type: Opaque
data:
  fernet-key: "UVVKNmNVeDNibTQ0WlZaNlpGQlBOSGhrZDFCb1drNW5hWE5pY1ZCRFdIbz0="
---
# Source: airflow/templates/create-user-job.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Create User Job
#################################
apiVersion: batch/v1
kind: Job
metadata:
  name: airflowdemo202-create-user
  labels:
    tier: airflow
    component: create-user-job
    release: airflowdemo202
    chart: "airflow-1.0.6"
    heritage: Helm
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "2"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        tier: airflow
        component: create-user-job
        release: airflowdemo202
    spec:
      securityContext:
          runAsUser: 50000
      restartPolicy: OnFailure
      nodeSelector:
        az: zone1
      affinity:
        {}
      tolerations:
        []
      containers:
        - name: create-user
          image: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images:apache-airflow-v2.0.1
          imagePullPolicy: IfNotPresent
          args:
            - "bash"
            - "-c"
            # Support running against 1.10.x and 2.0.0dev/master
            - 'airflow users create "$@" || airflow create_user "$@"'
            - --
            - "-r"
            - Admin
            - "-u"
            - admin
            - "-e"
            - admin@caspiandemo.com
            - "-f"
            - admin
            - "-l"
            - user
            - "-p"
            - admin@casp
          envFrom:          
            []
          env:          
            # Dynamically created environment variables
            # Dynamically created secret envs
            
            # Extra env          
            # Hard Coded Airflow Envs
            - name: AIRFLOW__CORE__FERNET_KEY
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-fernet-key
                  key: fernet-key
            - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-airflow-metadata
                  key: connection
            - name: AIRFLOW_CONN_AIRFLOW_DB
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-airflow-metadata
                  key: connection
          volumeMounts:
            - name: config
              mountPath: "/opt/airflow/airflow.cfg"
              subPath: airflow.cfg
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: airflowdemo202-airflow-config
MANIFEST:
---
# Source: airflow/templates/scheduler/scheduler-serviceaccount.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Scheduler ServiceAccount
#################################
kind: ServiceAccount
apiVersion: v1
metadata:
  name: airflowdemo202-scheduler
  labels:
    tier: airflow
    release: airflowdemo202
    chart: "airflow-1.0.6"
    heritage: Helm
  annotations:
    eks.amazonaws.com/role-arn: "arn:aws:iam::270579433622:role/ROLE-DEZ-USW2-DATAPLATFORM-01-SBX-AIRFLOWDEMO202-POD"
---
# Source: airflow/templates/webserver/webserver-serviceaccount.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

######################################
## Airflow Webserver ServiceAccount
######################################
kind: ServiceAccount
apiVersion: v1
metadata:
  name: airflowdemo202-webserver
  labels:
    tier: airflow
    release: airflowdemo202
    chart: "airflow-1.0.6"
    heritage: Helm
  annotations:
  
    eks.amazonaws.com/role-arn: arn:aws:iam::270579433622:role/ROLE-DEZ-USW2-DATAPLATFORM-01-SBX-AIRFLOWDEMO202-POD
---
# Source: airflow/templates/workers/worker-serviceaccount.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Worker ServiceAccount
#################################
kind: ServiceAccount
apiVersion: v1
metadata:
  name: airflowdemo202-worker
  labels:
    tier: airflow
    release: airflowdemo202
    chart: "airflow-1.0.6"
    heritage: Helm
  annotations:
    
    eks.amazonaws.com/role-arn: arn:aws:iam::270579433622:role/ROLE-DEZ-USW2-DATAPLATFORM-01-SBX-AIRFLOWDEMO202-POD
---
# Source: airflow/charts/postgresql/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  name: airflowdemo202-postgresql
  labels:
    app: postgresql
    chart: postgresql-6.3.12
    release: "airflowdemo202"
    heritage: "Helm"
type: Opaque
data:
  postgresql-password: "cG9zdGdyZXM="
---
# Source: airflow/templates/secrets/git-creds-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: airflowdemo202-git-creds
  labels:
    release: airflowdemo202
    chart: airflow
    heritage: Helm
type: Opaque
data:
  known_hosts: Yml0YnVja2V0Lm9yZyBzc2gtcnNhIEFBQUFCM056YUMxeWMyRUFBQUFCSXdBQUFRRUF1YmlOODFlRGNhZnJnTWVMemFGUHN3MmtOdkVjcVRLbC9WcUxhdC9NYUIzM3BaeTB5M3JKWnRucXdSMnFPT3Zid0taWUtpRU8xTzZWcU5FQnhLdkpKZWxDcTBkVFhXVDVwYk8yZ0RYQzZoNlFEWENhSG82cE9IR1BVeStZQmFHUVJHdVN1c01FQVNZaVd1bllOMHZDQUk4UWFYbldNWE5NZEZQM2pIQUpIMGVEc29pR25MUEJsQnA0VE5tNnJZSTc0bk16Z3ozQjlJaWtXNFdWSytkYzhLWkpaV1lqQXVPUlUzamMxYy9OUHNrRDJBU2luZjh2M3huZlhldWtVMHNKNU42bTVFOFZMak9iUEVPK21OMnQvRlpUTVpMaUZxUFdjL0FMU3FuTW5uaHdyTmkycmJmZy9yZC9JcEw4TGUzcFNCbmU4K3NlZUZWQm9HcXpITTl5WHc9PQo=
  ssh: LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFBQUFBQkc1dmJtVUFBQUFFYm05dVpRQUFBQUFBQUFBQkFBQUJsd0FBQUFkemMyZ3RjbgpOaEFBQUFBd0VBQVFBQUFZRUF3RWg1YjUrdWpubHhRdmV4bkZZL3AvcmRuM2JJRDZnVE93SDUrLzJGS0JDK3RVOW5PVU12CkFrTzF4WmxjMVM4a0tIS0EyblFzNEtveTV6enhKUXNISFcxSGVEQ0NKaFNGR0FLc3FCSFpwdHhiVlR3a2M1TUNNVmd1M2YKQm5ua0JraytWanBGS1ZCOUMyamtYN2xTbU9mZ1pXc2hESjBVWDVsUzd0VHpFUE56YjhDMjBkbTNwSnR3blhJWElsUjR6egpPUnFLak50STZXeGNLSGtNUzNQbDEvMjBBa3V3YnhmbHdSN0lVQTRuYmloWVFURTJCTXAwcXpvY2lXZi9wSzdGUmFFTVgxCmdyVzhVenI5aEN4QmFueHdXME5DK3VVUGpEb3grZkV0bEpZTEYyd1Z3UStqUnUrRzhKSEQwUzVEMFpPR2c3Vmw4NDhod0EKajBEWXUyd1g2Z2I1K3g0QVFjajRPSTFNMUpQaWs3Slhlc3U2MHlSbkxIS200ZEI1UUVIZUNTQVFCeTZUOUVuVkNETW5iegphTS9qVDNVYVhLbW10dFNscll1NUFMWVRReDlFc0N2bFBGTXVYenViVGxxS05OT1daaERJMk94MnRHcTlKa1hDTHBma1JJCndVb215R0NBdGNqUG9oWDN2NGk5TGhnZ0w1UHJaUXBpQWVqSEdRQVZBQUFGbUp4ZU9iQ2NYam13QUFBQUIzTnphQzF5YzIKRUFBQUdCQU1CSWVXK2ZybzU1Y1VMM3NaeFdQNmY2M1o5MnlBK29FenNCK2Z2OWhTZ1F2clZQWnpsREx3SkR0Y1daWE5VdgpKQ2h5Z05wMExPQ3FNdWM4OFNVTEJ4MXRSM2d3Z2lZVWhSZ0NyS2dSMmFiY1cxVThKSE9UQWpGWUx0M3daNTVBWkpQbFk2ClJTbFFmUXRvNUYrNVVwam40R1ZySVF5ZEZGK1pVdTdVOHhEemMyL0F0dEhadDZTYmNKMXlGeUpVZU04emthaW96YlNPbHMKWENoNURFdHo1ZGY5dEFKTHNHOFg1Y0VleUZBT0oyNG9XRUV4TmdUS2RLczZISWxuLzZTdXhVV2hERjlZSzF2Rk02L1lRcwpRV3A4Y0Z0RFF2cmxENHc2TWZueExaU1dDeGRzRmNFUG8wYnZodkNSdzlFdVE5R1Rob08xWmZPUEljQUk5QTJMdHNGK29HCitmc2VBRUhJK0RpTlROU1Q0cE95VjNyTHV0TWtaeXh5cHVIUWVVQkIzZ2tnRUFjdWsvUkoxUWd6SjI4MmpQNDA5MUdseXAKcHJiVXBhMkx1UUMyRTBNZlJMQXI1VHhUTGw4N20wNWFpalRUbG1ZUXlOanNkclJxdlNaRndpNlg1RVNNRktKc2hnZ0xYSQp6NklWOTcrSXZTNFlJQytUNjJVS1lnSG94eGtBRlFBQUFBTUJBQUVBQUFHQVUzM2t4UFJZVG1NckxBSHpyRWZESWtTTEFSCmdKck1xMWR2VFh3SFNINGlyTE5GMURIQmt4QzFHdFZ4ek5zMy9odW5KbHd2V1pHd0NzVTc0aGs0MGpUTUxMdXNPTmI4MlAKTVNyUUg3YUloS3pBTjlXQ21uQ21EaGtWV0tkdnhzWjlKYjhBTWpUdG8xUWNRTkRnZWhkdVdRaVZrb0k1cjlZcmxueW03TApFSHcxanJ2bVpsNmNJQ3lpaktzaW9uUjlkTE1XdDE1ODI3N2lkd0tON08yT0I5Vi9sQXRaSjZEUE1hZjIzSFd3T2FXWG5KClFKMkdzRFBjenhEUG5WWjhLZHo4NkM2MnJMYkM2cHY2aTdaTUU4SEM1Q2dPS0RWdTdHMnJTSzljaTV0ZXY5eEc1cDIxalkKS2pZeWFiM1FUd1hNVU9FOFRFMzh2QjRsaHBsRGNxMENzUWxheXBlZm5VK1QxODdFZUNrc0FlVUxZTTRhMnFEaTU4dVVPcgp6SEVjM3hRUnZBYWJhSjhSbkwvVTlDMHBqcEVPQXJ4ZnhueDJYaFJ4blFBVWRjZTJYazhlUEdKK0d6T0xiK0I1NDdUTVN0CjhOK3dWRmlHOStIdEtkVGI4VjhFQXBWdzY1ZEExTjR4V2JOdU0xZFh0QkQrZWJydE5sZGVGSGxScDNCellKM3lPTkFBQUEKd1FDQTI5dlVqa3NHTmxHVHo5dFc4dlJ1U1ZPb0xtOXdMNWNZUzd6bmNMQml6V3NZbDhHU0I2R2dOR2h6WUNZZ053K085bAp5VktHdFZ5V3BoOEhkdGU5emJYUnE3a0ZpVFA1a2gzYlNsZXJlc0xRUzllWVpOeXRNU2Q4QXRRK09RZi8wSHJaVGQzQzdMCmFyN3JOZnJiR1dMMExkSnFoREdTSzYvUGtuYm9LV0U3aEprRG5LcFRqYmdpWTZka0RXeCtob20vTE5wNWpSSEx5VzNRODQKTGJ4Wm4xVUROSW5KK3lyS1ZkaENTKzBmaHBUMktkdHprUDZQTW5WZVZWQ2dPZ3REVUFBQURCQVBUY29WNzRlSk95NGVCZAo3RitiV3p2V2VhQTFLK25kNW5BcjdDYkRqMVVhZ2FzNVd0WTZjNXdGY0pNczdoRnBHT29HMThMdDlENUd3K1ZLSEJGRVpSCllRQ2hZekxQTXpzZHRVeW5pUzF5ZUpIMGRGQUc2ZTgxdUM0Rk1QbEJuVnN0cXpJV0JwajFna25MZ0hmSi9pNnFtUHhkeFUKbWtaYUxKbXU1MmxzdGE4cmdEZjgwWGhKYk1hQzZRTnh6elYwZDJNREdyMGFnRyt4YklHd2lBZm1yaU9CSFp4VkxtMjgrbgpUckw2bXZ0WllmOWt0ZFFRYVZSK3VhVGhXNWFCSlp5d0FBQU1FQXlRZVRHaGJzZnlqaFZmem9ZU3dzVDhqQWtrOFpEUzh0Ci80aXBmcUdGbGx5NEh4QXJUWWNGeFhNOVRRK3pHUzZzYmNUYUx2cGwwT0RqTTZaN3J1N2RKY3ljQW00ME1ZeDcrVHduYUQKM1A3Sjc3TVZFOWQxaFk0QkxKbjgrT1NxMVVIeFdQRTFqdHVjWTVmZGVsandJeVpSckVSbFFvcGwrdXpuZ2hZUDkzVzcrbwozR2ZjMjR4dVpacksxcWpaelRybWVydm1CMHJFVFhJbkdHcGp0UThETXdrTGl4ZE1yZWtiSkdoUVJLM3FlZDBlQkcycVRBCmNPQUh4Yk1TcCtubEdmQUFBQUltdGhiSGxoYm1sQVMyRnNlV0Z1YVhNdFRXRmpRbTl2YXkxQmFYSXViRzlqWVd3PQotLS0tLUVORCBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0K
---
# Source: airflow/templates/secrets/metadata-connection-secret.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Metadata Secret
#################################

kind: Secret
apiVersion: v1
metadata:
  name: airflowdemo202-airflow-metadata
  labels:
    release: airflowdemo202
    chart: airflow
    heritage: Helm
type: Opaque
data:
  connection: "cG9zdGdyZXNxbDovL3Bvc3RncmVzOnBvc3RncmVzQGFpcmZsb3dkZW1vMjAyLXBvc3RncmVzcWwuY2xvdWRlei1kZW1vLnN2Yy5jbHVzdGVyLmxvY2FsOjU0MzIvcG9zdGdyZXM/c3NsbW9kZT1kaXNhYmxl"
---
# Source: airflow/templates/secrets/result-backend-connection-secret.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Result Backend Secret
#################################
kind: Secret
apiVersion: v1
metadata:
  name: airflowdemo202-airflow-result-backend
  labels:
    release: airflowdemo202
    chart: airflow
    heritage: Helm
type: Opaque
data:
  connection: "ZGIrcG9zdGdyZXNxbDovL3Bvc3RncmVzOnBvc3RncmVzQGFpcmZsb3dkZW1vMjAyLXBvc3RncmVzcWw6NTQzMi9wb3N0Z3Jlcz9zc2xtb2RlPWRpc2FibGU="
---
# Source: airflow/templates/configmaps/configmap.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow ConfigMap
#################################
apiVersion: v1
kind: ConfigMap
metadata:
  name: airflowdemo202-airflow-config
  labels:
    tier: airflow
    component: config
    release: airflowdemo202
    chart: "airflow-1.0.6"
    heritage: Helm
data:
  # These are system-specified config overrides.
  airflow.cfg: |-
    [api]
    auth_backend = airflow.api.auth.backend.deny_all
    
    [celery]
    default_queue = celery
    worker_concurrency = 16
    
    [core]
    colored_console_log = True
    dags_folder = /opt/airflow/dags/repo/
    executor = KubernetesExecutor
    load_examples = False
    
    [elasticsearch]
    json_format = True
    log_id_template = {dag_id}_{task_id}_{execution_date}_{try_number}
    
    [elasticsearch_configs]
    max_retries = 3
    retry_timeout = True
    timeout = 30
    
    [kerberos]
    ccache = /var/kerberos-ccache/cache
    keytab = /etc/airflow.keytab
    principal = airflow@FOO.COM
    reinit_frequency = 3600
    
    [kubernetes]
    airflow_configmap = airflowdemo202-airflow-config
    airflow_local_settings_configmap = airflowdemo202-airflow-config
    delete_worker_pods = True
    multi_namespace_mode = False
    namespace = cloudez-demo
    pod_template_file = /opt/airflow/pod_templates/pod_template_file.yaml
    worker_container_repository = 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images
    worker_container_tag = apache-airflow-v2.0.1
    
    [logging]
    colored_console_log = True
    fab_logging_level = DEBUG
    logging_level = INFO
    remote_base_log_folder = cloudwatch://arn:aws:logs:us-west-2:140199734014:log-group:airflow-logs
    remote_logging = true
    
    [metrics]
    statsd_host = airflowdemo202-statsd
    statsd_on = True
    statsd_port = 9125
    statsd_prefix = airflow
    
    [scheduler]
    run_duration = 41460
    scheduler_heartbeat_sec = 5
    statsd_host = airflowdemo202-statsd
    statsd_on = True
    statsd_port = 9125
    statsd_prefix = airflow
    
    [webserver]
    enable_proxy_fix = True
    rbac = True
    

  airflow_local_settings.py: |
  known_hosts: |
    
    bitbucket.org ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAubiN81eDcafrgMeLzaFPsw2kNvEcqTKl/VqLat/MaB33pZy0y3rJZtnqwR2qOOvbwKZYKiEO1O6VqNEBxKvJJelCq0dTXWT5pbO2gDXC6h6QDXCaHo6pOHGPUy+YBaGQRGuSusMEASYiWunYN0vCAI8QaXnWMXNMdFP3jHAJH0eDsoiGnLPBlBp4TNm6rYI74nMzgz3B9IikW4WVK+dc8KZJZWYjAuORU3jc1c/NPskD2ASinf8v3xnfXeukU0sJ5N6m5E8VLjObPEO+mN2t/FZTMZLiFqPWc/ALSqnMnnhwrNi2rbfg/rd/IpL8Le3pSBne8+seeFVBoGqzHM9yXw==
    
  pod_template_file.yaml: |-

    # Licensed to the Apache Software Foundation (ASF) under one
    # or more contributor license agreements.  See the NOTICE file
    # distributed with this work for additional information
    # regarding copyright ownership.  The ASF licenses this file
    # to you under the Apache License, Version 2.0 (the
    # "License"); you may not use this file except in compliance
    # with the License.  You may obtain a copy of the License at
    #
    #   http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing,
    # software distributed under the License is distributed on an
    # "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    # KIND, either express or implied.  See the License for the
    # specific language governing permissions and limitations
    # under the License.
    ---
    apiVersion: v1
    kind: Pod
    metadata:
      name: dummy-name
    spec:
      initContainers:    
        - name: git-sync
          image: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images:gcr-git-sync-v3.1.6
          imagePullPolicy: IfNotPresent
          securityContext:
            runAsUser: 65533
          env:
            - name: GIT_SSH_KEY_FILE
              value: "/etc/git-secret/ssh"
            - name: GIT_SYNC_SSH
              value: "true"
            - name: GIT_KNOWN_HOSTS
              value: "true"
            - name: GIT_SSH_KNOWN_HOSTS_FILE
              value: "/etc/git-secret/known_hosts"
            
            - name: GIT_SYNC_REV
              value: "HEAD"
            - name: GIT_SYNC_BRANCH
              value: "master"
            - name: GIT_SYNC_REPO
              value: "git@bitbucket.org:8kmilesinternal/dez-airflow-dags"
            - name: GIT_SYNC_DEPTH
              value: "1"
            - name: GIT_SYNC_ROOT
              value: "/git"
            - name: GIT_SYNC_DEST
              value: "repo"
            - name: GIT_SYNC_ADD_USER
              value: "true"
            - name: GIT_SYNC_WAIT
              value: "60"
            - name: GIT_SYNC_MAX_SYNC_FAILURES
              value: "0"
            - name: GIT_SYNC_ONE_TIME
              value: "true"
          volumeMounts:
          - name: dags
            mountPath: /git
          - name: git-sync-ssh-key
            mountPath: /etc/git-secret/ssh
            readOnly: true
            subPath: ssh
          - name: config
            mountPath: /etc/git-secret/known_hosts
            readOnly: true
            subPath: known_hosts
      containers:
        - args: []
          command: []
          envFrom:      
            []
          env:
            - name: AIRFLOW__CORE__EXECUTOR
              value: LocalExecutor      
            # Hard Coded Airflow Envs
            - name: AIRFLOW__CORE__FERNET_KEY
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-fernet-key
                  key: fernet-key
            - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-airflow-metadata
                  key: connection
            - name: AIRFLOW_CONN_AIRFLOW_DB
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-airflow-metadata
                  key: connection      
            # Dynamically created environment variables
            # Dynamically created secret envs
            
            # Extra env
          image: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images:apache-airflow-v2.0.1
          imagePullPolicy: IfNotPresent
          name: base
          ports: []
          volumeMounts:
            - mountPath: "/opt/airflow/logs"
              name: airflow-logs
            - name: config
              mountPath: "/opt/airflow/airflow.cfg"
              subPath: airflow.cfg
              readOnly: true
            - mountPath: /etc/git-secret/known_hosts
              name: git-sync-known-hosts
              subPath: known_hosts
            - mountPath: /etc/git-secret/ssh
              name: git-sync-ssh-key
              subPath: ssh
            - mountPath: /opt/airflow/dags/repo/
              name: dags
              readOnly: true
              subPath: repo/
      hostNetwork: false
      restartPolicy: Never
      securityContext:
        runAsUser: 50000
        fsGroup: 50000
      nodeSelector: 
        az: zone1
      affinity: 
        {}
      tolerations: 
        []
      serviceAccountName: airflowdemo202-worker
      volumes:
      - name: dags
        emptyDir: {}  
      - name: git-sync-ssh-key
        secret:
          secretName: airflowdemo202-git-creds
          defaultMode: 288
      - emptyDir: {}
        name: airflow-logs
      - configMap:
          defaultMode: 288
          name: airflowdemo202-airflow-config
        name: git-sync-known-hosts
      - configMap:
          name: airflowdemo202-airflow-config
        name: config
---
# Source: airflow/templates/configmaps/webserver-configmap.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow ConfigMap
#################################
apiVersion: v1
kind: ConfigMap
metadata:
  name: airflowdemo202-webserver-config
  labels:
    tier: airflow
    component: config
    release: airflowdemo202
    chart: "airflow-1.0.6"
    heritage: Helm
data:
  webserver_config.py: |
      from airflow import configuration as conf
      from flask_appbuilder.security.manager import AUTH_DB,AUTH_LDAP

      # The SQLAlchemy connection string.
      SQLALCHEMY_DATABASE_URI = conf.get('core', 'SQL_ALCHEMY_CONN')

      # Flask-WTF flag for CSRF
      CSRF_ENABLED = True

      AUTH_TYPE = AUTH_LDAP
      AUTH_LDAP_SERVER = "ldap://ldap.dataez.hti.com:389"
      AUTH_LDAP_USE_TLS = False

      # registration configs
      AUTH_USER_REGISTRATION = True
      AUTH_USER_REGISTRATION_ROLE = 'User'

      #AUTH_LDAP_UID_FIELD = 'sAMAccountName'
      AUTH_LDAP_FIRSTNAME_FIELD = 'givenName'
      AUTH_LDAP_LASTNAME_FIELD = 'sn'
      AUTH_LDAP_EMAIL_FIELD = 'mail'

      AUTH_LDAP_BASEDN = "DC=dataez,DC=hti,DC=com"

      # search configs
      AUTH_LDAP_SEARCH = "DC=dataez,DC=hti,DC=com"


      AUTH_LDAP_BIND_USER = "svc-airflow@dataez.hti.com"
      AUTH_LDAP_BIND_PASSWORD = "2SbKVMQ4Prj6"
      AUTH_LDAP_UID_FIELD = 'sAMAccountName'
      #
      #
      #
      AUTH_LDAP_SUPERUSER_FILTER='memberOf=CN=dez-airflow-admin-group,CN=Users,DC=dataez,DC=hti,DC=com'
      AUTH_LDAP_GROUP_MEMBER_ATTR='memberOf'
      AUTH_LDAP_USER_NAME_ATTR = 'uid'
      AUTH_LDAP_USER_FILTER = '|(memberOf=CN=dez-airflow-admin-group,CN=Users,DC=dataez,DC=hti,DC=com)(memberOf=CN=GROUP-DEZ-API-ALL-SBX-ADMIN,CN=Users,DC=dataez,DC=hti,DC=com)'
      AUTH_LDAP_ALLOW_SELF_SIGNED = True
---
# Source: airflow/templates/rbac/pod-launcher-role.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Pod Launcher Role
#################################
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: airflowdemo202-pod-launcher-role
  namespace: cloudez-demo
  labels:
    tier: airflow
    release: airflowdemo202
    chart: "airflow-1.0.6"
    heritage: Helm
rules:
  - apiGroups:
      - ""
    resources:
      - "pods"
    verbs:
      - "create"
      - "list"
      - "get"
      - "patch"
      - "watch"
      - "delete"
  - apiGroups:
      - ""
    resources:
      - "pods/log"
    verbs:
      - "get"
  - apiGroups:
      - ""
    resources:
      - "pods/exec"
    verbs:
      - "create"
      - "get"
  - apiGroups:
      - ""
    resources:
      - "events"
    verbs:
      - "list"
---
# Source: airflow/templates/rbac/pod-log-reader-role.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Pod Reader Role
#################################
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: airflowdemo202-pod-log-reader-role
  namespace: cloudez-demo
  labels:
    tier: airflow
    release: airflowdemo202
    chart: "airflow-1.0.6"
    heritage: Helm
rules:
  - apiGroups:
      - ""
    resources:
      - "pods"
    verbs:
      - "list"
      - "get"
      - "watch"
  - apiGroups:
      - ""
    resources:
      - "pods/log"
    verbs:
      - "get"
      - "list"
---
# Source: airflow/templates/rbac/pod-launcher-rolebinding.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Pod Launcher Role Binding
#################################
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: cloudez-demo
  name: airflowdemo202-pod-launcher-rolebinding
  labels:
    tier: airflow
    release: airflowdemo202
    chart: "airflow-1.0.6"
    heritage: Helm
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: airflowdemo202-pod-launcher-role
subjects:
  - kind: ServiceAccount
    name: airflowdemo202-scheduler
    namespace: cloudez-demo
  - kind: ServiceAccount
    name: airflowdemo202-worker
    namespace: cloudez-demo
---
# Source: airflow/templates/rbac/pod-log-reader-rolebinding.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Pod Reader Role Binding
#################################
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: cloudez-demo
  name: airflowdemo202-pod-log-reader-rolebinding
  labels:
    tier: airflow
    release: airflowdemo202
    chart: "airflow-1.0.6"
    heritage: Helm
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: airflowdemo202-pod-log-reader-role
subjects:
  - kind: ServiceAccount
    name: airflowdemo202-webserver
    namespace: cloudez-demo
---
# Source: airflow/charts/postgresql/templates/svc-headless.yaml
apiVersion: v1
kind: Service
metadata:
  name: airflowdemo202-postgresql-headless
  labels:
    app: postgresql
    chart: postgresql-6.3.12
    release: "airflowdemo202"
    heritage: "Helm"
spec:
  type: ClusterIP
  clusterIP: None
  ports:
  - name: postgresql
    port: 5432
    targetPort: postgresql
  selector:
    app: postgresql
    release: "airflowdemo202"
---
# Source: airflow/charts/postgresql/templates/svc.yaml
apiVersion: v1
kind: Service
metadata:
  name: airflowdemo202-postgresql
  labels:
    app: postgresql
    chart: postgresql-6.3.12
    release: "airflowdemo202"
    heritage: "Helm"
spec:
  type: ClusterIP
  ports:
  - name: postgresql
    port: 5432
    targetPort: postgresql
  selector:
    app: postgresql
    release: "airflowdemo202"
    role: master
---
# Source: airflow/templates/statsd/statsd-service.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow StatsD Service
#################################
kind: Service
apiVersion: v1
metadata:
  name: airflowdemo202-statsd
  labels:
    tier: airflow
    component: statsd
    release: airflowdemo202
    chart: "airflow-1.0.6"
    heritage: Helm
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9102"
spec:
  type: ClusterIP
  selector:
    tier: airflow
    component: statsd
    release: airflowdemo202
  ports:
    - name: statsd-ingest
      protocol: UDP
      port: 9125
      targetPort: 9125
    - name: statsd-scrape
      protocol: TCP
      port: 9102
      targetPort: 9102
---
# Source: airflow/templates/webserver/webserver-service.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Webserver Service
#################################
kind: Service
apiVersion: v1
metadata:
  name: airflowdemo202-webserver
  labels:
    tier: airflow
    component: webserver
    release: airflowdemo202
    chart: "airflow-1.0.6"
    heritage: Helm
spec:
  type: ClusterIP
  selector:
    tier: airflow
    component: webserver
    release: airflowdemo202
  ports:
    - name: airflow-ui
      protocol: TCP
      port: 8080
      targetPort: 8080
---
# Source: airflow/templates/scheduler/scheduler-deployment.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Scheduler Deployment/StatefulSet
#################################

# Are we using a local/sequential executor?
# Is persistence enabled on the _workers_?
# This is important because in $local mode, the scheduler assumes the role of the worker
# If we're using a StatefulSet
# If we're using elasticsearch logging

kind: Deployment
apiVersion: apps/v1
metadata:
  name: airflowdemo202-scheduler
  labels:
    tier: airflow
    component: scheduler
    release: airflowdemo202
    chart: "airflow-1.0.6"
    heritage: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      tier: airflow
      component: scheduler
      release: airflowdemo202
  template:
    metadata:
      labels:
        tier: airflow
        component: scheduler
        release: airflowdemo202
      annotations:
        checksum/metadata-secret: e532eba467b8b04d66dc87d2c1d6a2ec46b6bfe4b467245c6ff40c548a2db878
        checksum/result-backend-secret: a14689278517f03d3772aba9eb213966b0d5052a5a09c4a0d67abd9682dbd9d1
        checksum/pgbouncer-config-secret: da52bd1edfe820f0ddfacdebb20a4cc6407d296ee45bcb500a6407e2261a5ba2
        checksum/airflow-config: a20d9cde689ba274e7b8e64791a739f95f296db13c5a6c637a1e8130d73d82d6
        checksum/extra-configmaps: 2e44e493035e2f6a255d08f8104087ff10d30aef6f63176f1b18f75f73295598
        checksum/extra-secrets: bb91ef06ddc31c0c5a29973832163d8b0b597812a793ef911d33b622bc9d1655
        cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
    spec:
      nodeSelector:
        az: zone1
      affinity:
        {}
      tolerations:
        []
      restartPolicy: Always
      terminationGracePeriodSeconds: 10
      serviceAccountName: airflowdemo202-scheduler
      securityContext:
        runAsUser: 50000
        fsGroup: 50000
      initContainers:
        - name: wait-for-airflow-migrations
          image: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images:apache-airflow-v2.0.1
          imagePullPolicy: IfNotPresent
          args:          
            
            - python
            - -c
            - |
                  import airflow
                  import logging
                  import os
                  import time
          
                  from alembic.config import Config
                  from alembic.runtime.migration import MigrationContext
                  from alembic.script import ScriptDirectory
          
                  from airflow import settings
          
                  package_dir = os.path.abspath(os.path.dirname(airflow.__file__))
                  directory = os.path.join(package_dir, 'migrations')
                  config = Config(os.path.join(package_dir, 'alembic.ini'))
                  config.set_main_option('script_location', directory)
                  config.set_main_option('sqlalchemy.url', settings.SQL_ALCHEMY_CONN.replace('%', '%%'))
                  script_ = ScriptDirectory.from_config(config)
          
                  timeout=60
          
                  with settings.engine.connect() as connection:
                      context = MigrationContext.configure(connection)
                      ticker = 0
                      while True:
                          source_heads = set(script_.get_heads())
          
                          db_heads = set(context.get_current_heads())
                          if source_heads == db_heads:
                              break
          
                          if ticker >= timeout:
                              raise TimeoutError("There are still unapplied migrations after {} seconds.".format(ticker))
                          ticker += 1
                          time.sleep(1)
                          logging.info('Waiting for migrations... %s second(s)', ticker)
          envFrom:          
            []
          env:          
            # Dynamically created environment variables
            # Dynamically created secret envs
            
            # Extra env          
            # Hard Coded Airflow Envs
            - name: AIRFLOW__CORE__FERNET_KEY
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-fernet-key
                  key: fernet-key
            - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-airflow-metadata
                  key: connection
            - name: AIRFLOW_CONN_AIRFLOW_DB
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-airflow-metadata
                  key: connection
      containers:
        # Always run the main scheduler container.
        - name: scheduler
          image: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images:apache-airflow-v2.0.1
          imagePullPolicy: IfNotPresent
          args: ["bash", "-c", "exec airflow scheduler"]
          envFrom:          
            []
          env:          
            # Dynamically created environment variables
            # Dynamically created secret envs
            
            # Extra env          
            # Hard Coded Airflow Envs
            - name: AIRFLOW__CORE__FERNET_KEY
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-fernet-key
                  key: fernet-key
            - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-airflow-metadata
                  key: connection
            - name: AIRFLOW_CONN_AIRFLOW_DB
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-airflow-metadata
                  key: connection
          # If the scheduler stops heartbeating for 5 minutes (10*30s) kill the
          # scheduler and let Kubernetes restart it
          livenessProbe:
            failureThreshold: 10
            periodSeconds: 30
            exec:
              command:
              - python
              - -Wignore
              - -c
              - |
                import os
                os.environ['AIRFLOW__CORE__LOGGING_LEVEL'] = 'ERROR'
                os.environ['AIRFLOW__LOGGING__LOGGING_LEVEL'] = 'ERROR'

                from airflow.jobs.scheduler_job import SchedulerJob
                from airflow.utils.db import create_session
                from airflow.utils.net import get_hostname
                import sys

                with create_session() as session:
                    job = session.query(SchedulerJob).filter_by(hostname=get_hostname()).order_by(
                        SchedulerJob.latest_heartbeat.desc()).limit(1).first()

                sys.exit(0 if job.is_alive() else 1)
          resources:
            {}
          volumeMounts:
            - name: config
              mountPath: /opt/airflow/pod_templates/pod_template_file.yaml
              subPath: pod_template_file.yaml
              readOnly: true
            - name: logs
              mountPath: "/opt/airflow/logs"
            - name: config
              mountPath: "/opt/airflow/airflow.cfg"
              subPath: airflow.cfg
              readOnly: true
            - name: dags
              mountPath: /opt/airflow/dags        
        - name: git-sync
          image: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images:gcr-git-sync-v3.1.6
          imagePullPolicy: IfNotPresent
          securityContext:
            runAsUser: 65533
          env:
            - name: GIT_SSH_KEY_FILE
              value: "/etc/git-secret/ssh"
            - name: GIT_SYNC_SSH
              value: "true"
            - name: GIT_KNOWN_HOSTS
              value: "true"
            - name: GIT_SSH_KNOWN_HOSTS_FILE
              value: "/etc/git-secret/known_hosts"
            
            - name: GIT_SYNC_REV
              value: "HEAD"
            - name: GIT_SYNC_BRANCH
              value: "master"
            - name: GIT_SYNC_REPO
              value: "git@bitbucket.org:8kmilesinternal/dez-airflow-dags"
            - name: GIT_SYNC_DEPTH
              value: "1"
            - name: GIT_SYNC_ROOT
              value: "/git"
            - name: GIT_SYNC_DEST
              value: "repo"
            - name: GIT_SYNC_ADD_USER
              value: "true"
            - name: GIT_SYNC_WAIT
              value: "60"
            - name: GIT_SYNC_MAX_SYNC_FAILURES
              value: "0"
          volumeMounts:
          - name: dags
            mountPath: /git
          - name: git-sync-ssh-key
            mountPath: /etc/git-secret/ssh
            readOnly: true
            subPath: ssh
          - name: config
            mountPath: /etc/git-secret/known_hosts
            readOnly: true
            subPath: known_hosts
        # Always start the garbage collector sidecar.
        - name: scheduler-gc
          image: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images:apache-airflow-v2.0.1
          imagePullPolicy: IfNotPresent
          args: ["bash", "/clean-logs"]
          volumeMounts:
            - name: logs
              mountPath: "/opt/airflow/logs"
      volumes:
        - name: config
          configMap:
            name: airflowdemo202-airflow-config
        - name: dags
          emptyDir: {}        
        - name: git-sync-ssh-key
          secret:
            secretName: airflowdemo202-git-creds
            defaultMode: 288
        - name: logs
          emptyDir: {}
---
# Source: airflow/templates/statsd/statsd-deployment.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow StatsD Deployment
#################################
kind: Deployment
apiVersion: apps/v1
metadata:
  name: airflowdemo202-statsd
  labels:
    tier: airflow
    component: statsd
    release: airflowdemo202
    chart: "airflow-1.0.6"
    heritage: Helm
spec:
  replicas: 1
  selector:
    matchLabels:
      tier: airflow
      component: statsd
      release: airflowdemo202
  template:
    metadata:
      labels:
        tier: airflow
        component: statsd
        release: airflowdemo202
    spec:
      nodeSelector:
        az: zone1
      affinity:
        {}
      tolerations:
        []
      restartPolicy: Always
      containers:
        - name: statsd
          image: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images:airflow-statsd-exporter-2020.09.05-v0.17.0
          imagePullPolicy: IfNotPresent
          args:
            - "--statsd.mapping-config=/etc/statsd-exporter/mappings.yml"
          resources:
            {}
          ports:
            - name: statsd-ingest
              protocol: UDP
              containerPort: 9125
            - name: statsd-scrape
              containerPort: 9102
          livenessProbe:
            httpGet:
              path: /metrics
              port: 9102
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /metrics
              port: 9102
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
---
# Source: airflow/templates/webserver/webserver-deployment.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Webserver Deployment
#################################
kind: Deployment
apiVersion: apps/v1
metadata:
  name: airflowdemo202-webserver
  labels:
    tier: airflow
    component: webserver
    release: airflowdemo202
    chart: "airflow-1.0.6"
    heritage: Helm
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  selector:
    matchLabels:
      tier: airflow
      component: webserver
      release: airflowdemo202
  template:
    metadata:
      labels:
        tier: airflow
        component: webserver
        release: airflowdemo202
      annotations:
        checksum/metadata-secret: e532eba467b8b04d66dc87d2c1d6a2ec46b6bfe4b467245c6ff40c548a2db878
        checksum/pgbouncer-config-secret: da52bd1edfe820f0ddfacdebb20a4cc6407d296ee45bcb500a6407e2261a5ba2
        checksum/airflow-config: a20d9cde689ba274e7b8e64791a739f95f296db13c5a6c637a1e8130d73d82d6
        checksum/webserver-config: 0b98597c3803233ed1f8bdf9c0348e4b8e7097250cf60bae92e36e4d8888ce80
        checksum/extra-configmaps: 2e44e493035e2f6a255d08f8104087ff10d30aef6f63176f1b18f75f73295598
        checksum/extra-secrets: bb91ef06ddc31c0c5a29973832163d8b0b597812a793ef911d33b622bc9d1655
    spec:
      serviceAccountName: airflowdemo202-webserver
      nodeSelector:
        az: zone1
      affinity:
        {}
      tolerations:
        []
      restartPolicy: Always
      securityContext:
        runAsUser: 50000
        fsGroup: 50000
      initContainers:
        - name: wait-for-airflow-migrations
          image: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images:apache-airflow-v2.0.1
          imagePullPolicy: IfNotPresent
          args:          
            
            - python
            - -c
            - |
                  import airflow
                  import logging
                  import os
                  import time
          
                  from alembic.config import Config
                  from alembic.runtime.migration import MigrationContext
                  from alembic.script import ScriptDirectory
          
                  from airflow import settings
          
                  package_dir = os.path.abspath(os.path.dirname(airflow.__file__))
                  directory = os.path.join(package_dir, 'migrations')
                  config = Config(os.path.join(package_dir, 'alembic.ini'))
                  config.set_main_option('script_location', directory)
                  config.set_main_option('sqlalchemy.url', settings.SQL_ALCHEMY_CONN.replace('%', '%%'))
                  script_ = ScriptDirectory.from_config(config)
          
                  timeout=60
          
                  with settings.engine.connect() as connection:
                      context = MigrationContext.configure(connection)
                      ticker = 0
                      while True:
                          source_heads = set(script_.get_heads())
          
                          db_heads = set(context.get_current_heads())
                          if source_heads == db_heads:
                              break
          
                          if ticker >= timeout:
                              raise TimeoutError("There are still unapplied migrations after {} seconds.".format(ticker))
                          ticker += 1
                          time.sleep(1)
                          logging.info('Waiting for migrations... %s second(s)', ticker)
          envFrom:          
            []
          env:          
            # Dynamically created environment variables
            # Dynamically created secret envs
            
            # Extra env          
            # Hard Coded Airflow Envs
            - name: AIRFLOW__CORE__FERNET_KEY
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-fernet-key
                  key: fernet-key
            - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-airflow-metadata
                  key: connection
            - name: AIRFLOW_CONN_AIRFLOW_DB
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-airflow-metadata
                  key: connection
      containers:        
        - name: git-sync
          image: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images:gcr-git-sync-v3.1.6
          imagePullPolicy: IfNotPresent
          securityContext:
            runAsUser: 65533
          env:
            - name: GIT_SSH_KEY_FILE
              value: "/etc/git-secret/ssh"
            - name: GIT_SYNC_SSH
              value: "true"
            - name: GIT_KNOWN_HOSTS
              value: "true"
            - name: GIT_SSH_KNOWN_HOSTS_FILE
              value: "/etc/git-secret/known_hosts"
            
            - name: GIT_SYNC_REV
              value: "HEAD"
            - name: GIT_SYNC_BRANCH
              value: "master"
            - name: GIT_SYNC_REPO
              value: "git@bitbucket.org:8kmilesinternal/dez-airflow-dags"
            - name: GIT_SYNC_DEPTH
              value: "1"
            - name: GIT_SYNC_ROOT
              value: "/git"
            - name: GIT_SYNC_DEST
              value: "repo"
            - name: GIT_SYNC_ADD_USER
              value: "true"
            - name: GIT_SYNC_WAIT
              value: "60"
            - name: GIT_SYNC_MAX_SYNC_FAILURES
              value: "0"
          volumeMounts:
          - name: dags
            mountPath: /git
          - name: git-sync-ssh-key
            mountPath: /etc/git-secret/ssh
            readOnly: true
            subPath: ssh
          - name: config
            mountPath: /etc/git-secret/known_hosts
            readOnly: true
            subPath: known_hosts
        - name: webserver
          image: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images:apache-airflow-v2.0.1
          imagePullPolicy: IfNotPresent
          args: ["bash", "-c", "exec airflow webserver"]
          resources:
            {}
          volumeMounts:
            - name: config
              mountPath: "/opt/airflow/airflow.cfg"
              subPath: airflow.cfg
              readOnly: true
            - name: webserver-config
              mountPath: "/opt/airflow/webserver_config.py"
              subPath: webserver_config.py
              readOnly: true
            - name: dags
              mountPath: /opt/airflow/dags
          ports:
            - name: webserver-ui
              containerPort: 8080
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 15
            timeoutSeconds: 30
            failureThreshold: 20
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 15
            timeoutSeconds: 30
            failureThreshold: 20
            periodSeconds: 5
          envFrom:          
            []
          env:          
            # Dynamically created environment variables
            # Dynamically created secret envs
            
            # Extra env          
            # Hard Coded Airflow Envs
            - name: AIRFLOW__CORE__FERNET_KEY
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-fernet-key
                  key: fernet-key
            - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-airflow-metadata
                  key: connection
            - name: AIRFLOW_CONN_AIRFLOW_DB
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-airflow-metadata
                  key: connection
      volumes:
        - name: config
          configMap:
            name: airflowdemo202-airflow-config
        - name: webserver-config
          configMap:
            name: airflowdemo202-webserver-config
        - name: dags
          emptyDir: {}        
        - name: git-sync-ssh-key
          secret:
            secretName: airflowdemo202-git-creds
            defaultMode: 288
---
# Source: airflow/charts/postgresql/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: airflowdemo202-postgresql
  labels:
    app: postgresql
    chart: postgresql-6.3.12
    release: "airflowdemo202"
    heritage: "Helm"
spec:
  serviceName: airflowdemo202-postgresql-headless
  replicas: 1
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app: postgresql
      release: "airflowdemo202"
      role: master
  template:
    metadata:
      name: airflowdemo202-postgresql
      labels:
        app: postgresql
        chart: postgresql-6.3.12
        release: "airflowdemo202"
        heritage: "Helm"
        role: master
    spec:      
      securityContext:
        fsGroup: 1001
      initContainers:
      - name: init-chmod-data
        image: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images:bitnami-minideb-stretch
        imagePullPolicy: "Always"
        resources:
          requests:
            cpu: 250m
            memory: 256Mi
        command:
          - sh
          - -c
          - |
            mkdir -p /bitnami/postgresql/data
            chmod 700 /bitnami/postgresql/data
            find /bitnami/postgresql -mindepth 0 -maxdepth 1 -not -name ".snapshot" -not -name "lost+found" | \
              xargs chown -R 1001:1001
        securityContext:
          runAsUser: 0
        volumeMounts:
        - name: data
          mountPath: /bitnami/postgresql
          subPath: 
      containers:
      - name: airflowdemo202-postgresql
        image: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images:bitnami-postgresql-11.5.0-debian-9-r60
        imagePullPolicy: "IfNotPresent"
        resources:
          requests:
            cpu: 250m
            memory: 256Mi
        securityContext:
          runAsUser: 1001
        env:
        - name: BITNAMI_DEBUG
          value: "false"
        - name: POSTGRESQL_PORT_NUMBER
          value: "5432"
        - name: POSTGRESQL_VOLUME_DIR
          value: "/bitnami/postgresql"
        - name: PGDATA
          value: "/bitnami/postgresql/data"
        - name: POSTGRES_USER
          value: "postgres"
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: airflowdemo202-postgresql
              key: postgresql-password
        ports:
        - name: postgresql
          containerPort: 5432
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - exec pg_isready -U "postgres" -h 127.0.0.1 -p 5432
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 6
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - -e
            - |
              pg_isready -U "postgres" -h 127.0.0.1 -p 5432
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 5
          successThreshold: 1
          failureThreshold: 6
        volumeMounts:
        - name: data
          mountPath: /bitnami/postgresql
          subPath: 
      volumes:
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes:
          - "ReadWriteOnce"
        resources:
          requests:
            storage: "8Gi"
---
# Source: airflow/templates/migrate-database-job.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Run Migrations
#################################
apiVersion: batch/v1
kind: Job
metadata:
  name: airflowdemo202-run-airflow-migrations
  labels:
    tier: airflow
    component: run-airflow-migrations
    release: airflowdemo202
    chart: "airflow-1.0.6"
    heritage: Helm
spec:
  template:
    metadata:
      labels:
        tier: airflow
        component: run-airflow-migrations
        release: airflowdemo202
    spec:
      securityContext:
          runAsUser: 50000
      restartPolicy: OnFailure
      nodeSelector:
        az: zone1
      affinity:
        {}
      tolerations:
        []
      containers:
        - name: run-airflow-migrations
          image: 140199734014.dkr.ecr.us-west-2.amazonaws.com/common-images:apache-airflow-v2.0.1
          imagePullPolicy: IfNotPresent
          # Support running against 1.10.x and 2.0.0dev/master
          args: ["bash", "-c", "airflow db upgrade || airflow upgradedb"]
          envFrom:          
            []
          env:          
            # Dynamically created environment variables
            # Dynamically created secret envs
            
            # Extra env          
            # Hard Coded Airflow Envs
            - name: AIRFLOW__CORE__FERNET_KEY
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-fernet-key
                  key: fernet-key
            - name: AIRFLOW__CORE__SQL_ALCHEMY_CONN
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-airflow-metadata
                  key: connection
            - name: AIRFLOW_CONN_AIRFLOW_DB
              valueFrom:
                secretKeyRef:
                  name: airflowdemo202-airflow-metadata
                  key: connection
          volumeMounts:
            - name: config
              mountPath: "/opt/airflow/airflow.cfg"
              subPath: airflow.cfg
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: airflowdemo202-airflow-config
---
# Source: airflow/templates/webserver/webserver-ingress.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Webserver Ingress
#################################
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: airflowdemo202-airflow-ingress
  labels:
    tier: airflow
    component: airflow-ingress
    release: airflowdemo202
    chart: "airflow-1.0.6"
    heritage: Helm
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
    - http:
        paths:
          - backend:
              serviceName: airflowdemo202-webserver
              servicePort: airflow-ui
      host: airflowdemo202-sbx.dataez.hti.com
---
# Source: airflow/templates/check-values.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
---
# Source: airflow/templates/cleanup/cleanup-cronjob.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Cleanup Pods CronJob
#################################
---
# Source: airflow/templates/cleanup/cleanup-serviceaccount.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Cleanup ServiceAccount
#################################
---
# Source: airflow/templates/configmaps/extra-configmaps.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

####################################################
## Extra ConfigMaps provisioned via the chart values
####################################################
---
# Source: airflow/templates/configmaps/statsd-configmap.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow StatsD ConfigMap
#################################
---
# Source: airflow/templates/dags-persistent-volume-claim.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
---
# Source: airflow/templates/flower/flower-deployment.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Flower Deployment
#################################
---
# Source: airflow/templates/flower/flower-ingress.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Flower Ingress
#################################
---
# Source: airflow/templates/flower/flower-networkpolicy.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Flower NetworkPolicy
#################################
---
# Source: airflow/templates/flower/flower-service.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Flower Service Component
#################################
---
# Source: airflow/templates/limitrange.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Namespace LimitRange
#################################
---
# Source: airflow/templates/pgbouncer/pgbouncer-deployment.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Pgbouncer Deployment
#################################
---
# Source: airflow/templates/pgbouncer/pgbouncer-networkpolicy.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Pgbouncer NetworkPolicy
#################################
---
# Source: airflow/templates/pgbouncer/pgbouncer-poddisruptionbudget.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Pgbouncer PodDisruptionBudget
#################################
---
# Source: airflow/templates/pgbouncer/pgbouncer-service.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Pgbouncer Service
#################################
---
# Source: airflow/templates/rbac/pod-cleanup-role.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Cleanup Role
#################################
---
# Source: airflow/templates/rbac/pod-cleanup-rolebinding.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Cleanup Role Binding
#################################
---
# Source: airflow/templates/redis/redis-networkpolicy.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Redis NetworkPolicy
#################################
---
# Source: airflow/templates/redis/redis-service.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Redis Service
#################################
---
# Source: airflow/templates/redis/redis-statefulset.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Redis StatefulSet
#################################
---
# Source: airflow/templates/resourcequota.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Namespace ResourceQuota
#################################
---
# Source: airflow/templates/scheduler/scheduler-networkpolicy.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Scheduler NetworkPolicy
#################################
---
# Source: airflow/templates/scheduler/scheduler-poddisruptionbudget.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Scheduler PodDisruptionBudget
#################################
---
# Source: airflow/templates/scheduler/scheduler-service.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Scheduler Service
#################################
---
# Source: airflow/templates/secrets/elasticsearch-secret.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Elasticsearch Secret
#################################
---
# Source: airflow/templates/secrets/extra-secrets.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

#################################################
## Extra Secrets provisioned via the chart values
#################################################
---
# Source: airflow/templates/secrets/flower-secret.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Flower Secret
#################################
---
# Source: airflow/templates/secrets/pgbouncer-certificates-secret.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Pgbouncer Certificate Secret
#################################
---
# Source: airflow/templates/secrets/pgbouncer-config-secret.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Pgbouncer Config Secret
#################################
---
# Source: airflow/templates/secrets/pgbouncer-stats-secret.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Pgbouncer Stats Secret
#################################
---
# Source: airflow/templates/secrets/redis-secrets.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Redis Password Secret
#################################
---
# Source: airflow/templates/secrets/registry-secret.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Registry Secret
#################################
---
# Source: airflow/templates/statsd/statsd-networkpolicy.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow StatsD NetworkPolicy
#################################
---
# Source: airflow/templates/webserver/webserver-networkpolicy.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Webserver NetworkPolicy
#################################
---
# Source: airflow/templates/workers/worker-deployment.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Worker Deployment
#################################
---
# Source: airflow/templates/workers/worker-kedaautoscaler.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Worker KEDA Scaler
#################################
---
# Source: airflow/templates/workers/worker-networkpolicy.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Worker NetworkPolicy
#################################
---
# Source: airflow/templates/workers/worker-service.yaml
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

################################
## Airflow Worker Service
#################################

NOTES:
Thank you for installing Airflow!

Your release is named airflowdemo202.
You can now access your dashboard(s) by following defined Ingress urls:

Airflow dashboard:     http://airflowdemo202-sbx.dataez.hti.com/
